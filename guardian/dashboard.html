<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Informes - Thinking Skills Program</title>
  <style>
    :root {
      --primary: #4f46e5;
      --primary-light: #818cf8;
      --primary-dark: #3730a3;
      --success: #059669;
      --success-light: #d1fae5;
      --warning: #d97706;
      --warning-light: #fef3c7;
      --danger: #dc2626;
      --danger-light: #fee2e2;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --white: #ffffff;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-50);
      min-height: 100vh;
      color: var(--gray-800);
      line-height: 1.5;
    }
    
    /* Header */
    .header {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      padding: 0 24px;
      height: 64px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      height: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
    }
    
    .logo-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--gray-900);
      letter-spacing: -0.02em;
    }
    
    .logo-text span {
      display: block;
      color: var(--gray-500);
      font-weight: 400;
      font-size: 12px;
      letter-spacing: 0;
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-ghost {
      background: transparent;
      color: var(--gray-600);
    }
    
    .btn-ghost:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }
    
    /* Main Container */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }
    
    /* Student Selector */
    .student-selector {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 32px;
      box-shadow: var(--shadow);
    }
    
    .section-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }
    
    .students-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
    }
    
    .student-card {
      border: 2px solid var(--gray-200);
      border-radius: var(--radius);
      padding: 16px;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--white);
    }
    
    .student-card:hover {
      border-color: var(--primary-light);
      background: #fafafe;
    }
    
    .student-card.selected {
      border-color: var(--primary);
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
    }
    
    .student-avatar {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .student-info h3 {
      font-size: 15px;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 2px;
    }
    
    .student-info p {
      font-size: 13px;
      color: var(--gray-500);
    }
    
    /* Dashboard Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      background: var(--gray-100);
      padding: 4px;
      border-radius: var(--radius);
      width: fit-content;
    }
    
    .tab {
      padding: 10px 20px;
      border: none;
      background: transparent;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-600);
      transition: all 0.15s ease;
    }
    
    .tab:hover {
      color: var(--gray-900);
    }
    
    .tab.active {
      background: var(--white);
      color: var(--gray-900);
      box-shadow: var(--shadow-sm);
    }
    
    /* Quick Summary */
    .quick-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }
    
    @media (max-width: 900px) {
      .quick-summary {
        grid-template-columns: 1fr;
      }
    }
    
    .summary-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    
    .summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
    }
    
    .summary-card.lectura::before { background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%); }
    .summary-card.creatividad::before { background: linear-gradient(90deg, #7c3aed 0%, #a78bfa 100%); }
    .summary-card.ejercicios::before { background: linear-gradient(90deg, #0891b2 0%, #22d3ee 100%); }
    
    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .summary-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    .summary-trend {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
    }
    
    .trend-up { background: var(--success-light); color: var(--success); }
    .trend-down { background: var(--danger-light); color: var(--danger); }
    .trend-same { background: var(--gray-100); color: var(--gray-500); }
    
    .summary-value {
      font-size: 42px;
      font-weight: 700;
      color: var(--gray-900);
      line-height: 1;
      margin-bottom: 4px;
      letter-spacing: -0.02em;
    }
    
    .summary-label {
      font-size: 14px;
      color: var(--gray-500);
    }
    
    .summary-meta {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--gray-100);
      font-size: 13px;
      color: var(--gray-500);
      display: flex;
      gap: 16px;
    }
    
    .summary-meta strong {
      color: var(--gray-700);
    }
    
    /* Content Sections */
    .section {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--gray-100);
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    
    .section-icon.lectura { background: #ede9fe; }
    .section-icon.creatividad { background: #fae8ff; }
    .section-icon.ejercicios { background: #cffafe; }
    
    /* Metric Cards */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }
    
    .metric-card {
      background: var(--gray-50);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
      border: 1px solid var(--gray-100);
    }
    
    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 4px;
      letter-spacing: -0.02em;
    }
    
    .metric-label {
      font-size: 13px;
      color: var(--gray-500);
      margin-bottom: 8px;
    }
    
    .metric-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    .badge-excellent { background: var(--success-light); color: var(--success); }
    .badge-good { background: #dbeafe; color: #1d4ed8; }
    .badge-needs-work { background: var(--warning-light); color: var(--warning); }
    .badge-low { background: var(--danger-light); color: var(--danger); }
    
    /* Info Tooltip */
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      background: var(--gray-200);
      border-radius: 50%;
      font-size: 10px;
      color: var(--gray-500);
      cursor: help;
      margin-left: 4px;
      font-weight: 600;
    }
    
    /* Cycle Navigator */
    .cycle-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .cycle-nav button {
      width: 32px;
      height: 32px;
      border: 1px solid var(--gray-200);
      background: var(--white);
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--gray-500);
      transition: all 0.15s ease;
    }
    
    .cycle-nav button:hover:not(:disabled) {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }
    
    .cycle-nav button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .cycle-indicator {
      font-size: 14px;
      color: var(--gray-700);
      font-weight: 500;
      min-width: 100px;
      text-align: center;
    }
    
    /* Detail Cards */
    .detail-card {
      background: var(--gray-50);
      border-radius: var(--radius);
      padding: 20px;
      margin-top: 20px;
      border: 1px solid var(--gray-100);
    }
    
    .detail-card h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--gray-200);
      font-size: 14px;
    }
    
    .detail-row:last-child {
      border-bottom: none;
    }
    
    .detail-row span:first-child {
      color: var(--gray-600);
    }
    
    .detail-row span:last-child {
      color: var(--gray-900);
      font-weight: 500;
    }
    
    /* Exercise Card */
    .exercise-card {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .exercise-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    
    .exercise-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 4px;
    }
    
    .exercise-type {
      font-size: 12px;
      color: var(--primary);
      font-weight: 600;
      background: #ede9fe;
      padding: 4px 10px;
      border-radius: 20px;
    }
    
    .skill-badge {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .skill-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-700);
    }
    
    .skill-description {
      font-size: 12px;
      color: var(--gray-500);
      font-style: italic;
      max-width: 300px;
    }
    
    /* Chart Container */
    .chart-wrapper {
      background: var(--gray-50);
      border-radius: var(--radius);
      padding: 20px;
      margin: 16px 0;
    }
    
    .chart-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-600);
      margin-bottom: 12px;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 48px 20px;
      color: var(--gray-500);
    }
    
    .empty-state-icon {
      font-size: 40px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
    
    .empty-state h3 {
      font-size: 16px;
      color: var(--gray-700);
      margin-bottom: 6px;
    }
    
    .empty-state p {
      font-size: 14px;
    }
    
    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      flex-direction: column;
      gap: 16px;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .hidden { display: none !important; }
    
    /* Comparison Bar */
    .comparison-container {
      margin-top: 16px;
    }
    
    .comparison-label {
      font-size: 12px;
      color: var(--gray-500);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
    }
    
    .comparison-bar {
      background: var(--gray-200);
      height: 6px;
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }
    
    .comparison-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }
    
    .comparison-marker {
      position: absolute;
      top: -3px;
      width: 2px;
      height: 12px;
      background: var(--gray-700);
      border-radius: 1px;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      backdrop-filter: blur(4px);
    }
    
    .modal-content {
      background: var(--white);
      border-radius: var(--radius-lg);
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }
    
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: var(--white);
      z-index: 10;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--gray-100);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 18px;
      color: var(--gray-500);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    
    .modal-close:hover {
      background: var(--gray-200);
      color: var(--gray-700);
    }
    
    .modal-body {
      padding: 24px;
    }
    
    /* Reading Content */
    .reading-text {
      font-family: 'Georgia', serif;
      font-size: 16px;
      line-height: 1.9;
      color: var(--gray-700);
      text-align: justify;
      padding: 24px;
      background: #fffbf5;
      border-radius: var(--radius);
      border: 1px solid #f5e6d3;
      margin-bottom: 24px;
    }
    
    /* Question Card */
    .question-card {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .question-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .question-status {
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .question-text {
      font-size: 15px;
      font-weight: 500;
      color: var(--gray-800);
      flex: 1;
    }
    
    .option-item {
      padding: 10px 14px;
      margin: 8px 0;
      border-radius: var(--radius-sm);
      font-size: 14px;
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
    }
    
    .option-item.correct {
      background: var(--success-light);
      border-color: var(--success);
    }
    
    .option-item.incorrect {
      background: var(--danger-light);
      border-color: var(--danger);
    }
    
    .option-indicator {
      font-size: 16px;
    }
    
    .justification-box {
      margin-top: 12px;
      padding: 14px;
      background: #e0f2fe;
      border-radius: var(--radius-sm);
      border-left: 3px solid #0284c7;
      font-size: 13px;
      color: var(--gray-700);
    }
    
    .justification-box strong {
      color: #0369a1;
    }
    
    /* Creativity Preview */
    .creativity-preview {
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      overflow: hidden;
      margin: 16px 0;
    }
    
    .creativity-preview img {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .creativity-preview iframe {
      width: 100%;
      height: 500px;
      border: none;
    }
    
    /* Grade Badge */
    .grade-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      color: var(--primary);
      background: #ede9fe;
      padding: 4px 10px;
      border-radius: 20px;
      margin-left: 8px;
    }
    
    /* ============================================
       ESTILOS PARA GR√ÅFICOS CHART.JS
       ============================================ */
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 20px;
    }
    
    @media (max-width: 900px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .chart-container {
      background: var(--white);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      position: relative;
    }
    
    .chart-container canvas {
      max-height: 280px;
    }
    
    .chart-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .chart-subtitle {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 8px;
    }
    
    .chart-full-width {
      grid-column: 1 / -1;
    }
    
    /* Tarjetas de Habilidades */
    .habilidades-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 20px;
    }
    
    @media (max-width: 900px) {
      .habilidades-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .habilidad-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: box-shadow 0.2s ease;
    }
    
    .habilidad-card:hover {
      box-shadow: var(--shadow-md);
    }
    
    .habilidad-header {
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    
    .habilidad-header:hover {
      background: var(--gray-50);
    }
    
    .habilidad-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .habilidad-icon {
      font-size: 24px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gray-100);
      border-radius: var(--radius-sm);
    }
    
    .habilidad-nombre {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-800);
    }
    
    .habilidad-descripcion {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 2px;
    }
    
    .habilidad-resultado {
      text-align: right;
    }
    
    .habilidad-porcentaje {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .habilidad-tendencia {
      font-size: 11px;
      color: var(--gray-500);
    }
    
    .habilidad-expand-btn {
      background: none;
      border: none;
      font-size: 16px;
      color: var(--gray-400);
      cursor: pointer;
      transition: transform 0.2s ease;
      padding: 4px;
    }
    
    .habilidad-card.expanded .habilidad-expand-btn {
      transform: rotate(180deg);
    }
    
    .habilidad-chart-container {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      border-top: 1px solid var(--gray-100);
    }
    
    .habilidad-card.expanded .habilidad-chart-container {
      max-height: 300px;
    }
    
    .habilidad-chart-inner {
      padding: 16px 20px;
    }
    
    .habilidad-chart-inner canvas {
      max-height: 200px;
    }
    
    /* Tooltip personalizado */
    .chart-tooltip-container {
      position: absolute;
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      box-shadow: var(--shadow-lg);
      pointer-events: none;
      z-index: 1000;
      font-size: 13px;
    }
    
    /* Bot√≥n ver detalle en gr√°ficos */
    .chart-detail-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 11px;
      padding: 4px 10px;
      background: var(--gray-100);
      color: var(--gray-600);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .chart-detail-btn:hover {
      background: var(--primary);
      color: white;
    }
    
    /* Leyenda de gr√°ficos */
    .chart-legend {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 12px;
      font-size: 12px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--gray-600);
    }
    
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    /* ============================================
       ACCESIBILIDAD Y RESPONSIVE ADICIONAL
       ============================================ */
    
    /* Focus visible para navegaci√≥n por teclado */
    .habilidad-header:focus,
    .habilidad-expand-btn:focus,
    .chart-detail-btn:focus,
    button:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    /* Reducir movimiento para usuarios con preferencia */
    @media (prefers-reduced-motion: reduce) {
      .habilidad-chart-container {
        transition: none;
      }
      .habilidad-expand-btn {
        transition: none;
      }
    }
    
    /* Tablet landscape */
    @media (min-width: 768px) and (max-width: 1024px) {
      .charts-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .charts-grid .chart-container:last-child {
        grid-column: 1 / -1;
      }
      .habilidades-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* M√≥vil peque√±o */
    @media (max-width: 480px) {
      .chart-container {
        padding: 12px;
      }
      .chart-title {
        font-size: 13px;
      }
      .chart-subtitle {
        font-size: 11px;
      }
      .habilidad-header {
        padding: 12px 14px;
        flex-wrap: wrap;
        gap: 12px;
      }
      .habilidad-info {
        flex: 1 1 100%;
      }
      .habilidad-porcentaje {
        font-size: 18px;
      }
    }
    
    /* Alto contraste */
    @media (prefers-contrast: high) {
      .chart-container {
        border: 2px solid var(--gray-700);
      }
      .habilidad-card {
        border: 2px solid var(--gray-700);
      }
    }
    
    /* Ocultar visualmente pero accesible para lectores de pantalla */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
  
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <!-- Loading State -->
  <div id="loadingState" class="loading">
    <div class="loading-spinner"></div>
    <p style="color: var(--gray-500);">Cargando informaci√≥n...</p>
  </div>
  
  <!-- Main Content -->
  <div id="mainContent" class="hidden">
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <div class="logo-icon">üß†</div>
          <div class="logo-text">
            Thinking Skills
            <span>Informe de Progreso</span>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="exportarPDF()">
            üìÑ Exportar PDF
          </button>
          <button class="btn btn-ghost" id="btnLogout">
            Cerrar Sesi√≥n
          </button>
        </div>
      </div>
    </header>
    
    <main class="main">
      <!-- Student Selector -->
      <section class="student-selector">
        <div class="section-label">Seleccionar Estudiante</div>
        <div class="students-grid" id="studentsGrid"></div>
      </section>
      
      <!-- Dashboard Content -->
      <div id="dashboardContent" class="hidden">
        <!-- Alerts -->
        <div id="alertsContainer"></div>
        
        <!-- Quick Summary -->
        <div class="quick-summary">
          <div class="summary-card lectura">
            <div class="summary-header">
              <span class="summary-title">üìö Lectura Cr√≠tica</span>
              <span class="summary-trend trend-same" id="trendLectura">‚Üí Estable</span>
            </div>
            <div class="summary-value" id="summaryLecturaValue">--</div>
            <div class="summary-label">Velocidad Efectiva <span class="grade-badge" id="gradeBadge"></span></div>
            <div class="summary-meta">
              <span>Comprensi√≥n: <strong id="summaryComprension">--%</strong></span>
              <span>Velocidad: <strong id="summaryVelocidad">-- PPM</strong></span>
            </div>
          </div>
          
          <div class="summary-card creatividad">
            <div class="summary-header">
              <span class="summary-title">üé® Creatividad</span>
              <span class="summary-trend trend-same" id="trendCreatividad">‚Üí Estable</span>
            </div>
            <div class="summary-value" id="summaryCreatividadValue">--%</div>
            <div class="summary-label">Calificaci√≥n Docente</div>
            <div class="summary-meta" id="summaryCreatividadMeta">
              <span>√öltimo ciclo completado</span>
            </div>
          </div>
          
          <div class="summary-card ejercicios">
            <div class="summary-header">
              <span class="summary-title">üéÆ Ejercicios Digitales</span>
              <span class="summary-trend trend-same" id="trendEjercicios">‚Üí Estable</span>
            </div>
            <div class="summary-value" id="summaryEjerciciosValue">--%</div>
            <div class="summary-label">Rendimiento Promedio</div>
            <div class="summary-meta">
              <span>Metas alcanzadas: <strong id="summaryMetas">-/-</strong></span>
            </div>
          </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" data-tab="ciclo">Ciclo Actual</button>
          <button class="tab" data-tab="comparativo">Comparativo</button>
          <button class="tab" data-tab="historial">Historial</button>
        </div>
        
        <!-- Tab: Ciclo Actual -->
        <div id="tabCiclo" class="tab-content">
          <!-- Cycle Navigator -->
          <div class="section">
            <div class="section-header">
              <h3 class="section-title">Navegaci√≥n de Ciclos</h3>
              <div class="cycle-nav">
                <button onclick="cicloAnterior()" id="btnCicloAnterior">‚Üê</button>
                <span class="cycle-indicator" id="cycleIndicator">Ciclo 1 de 1</span>
                <button onclick="cicloSiguiente()" id="btnCicloSiguiente">‚Üí</button>
              </div>
            </div>
          </div>
          
          <!-- Lectura Section -->
          <div class="section" id="sectionLectura">
            <div class="section-header">
              <h3 class="section-title">
                <span class="section-icon lectura">üìö</span>
                Lectura Cr√≠tica
              </h3>
            </div>
            
            <!-- Gr√°ficos de Progreso por Ciclo -->
            <div class="charts-grid" id="chartsLectura">
              <div class="chart-container">
                <div class="chart-title">üìä Velocidad Simple (PPM)</div>
                <canvas id="chartVelocidadSimple" aria-label="Gr√°fico de velocidad de lectura por ciclo" role="img"></canvas>
                <div class="chart-subtitle">Palabras le√≠das por minuto en cada ciclo</div>
              </div>
              <div class="chart-container">
                <div class="chart-title">üìä Comprensi√≥n (%)</div>
                <canvas id="chartComprension" aria-label="Gr√°fico de comprensi√≥n lectora por ciclo" role="img"></canvas>
                <div class="chart-subtitle">Porcentaje de respuestas correctas</div>
              </div>
              <div class="chart-container">
                <div class="chart-title">üìä Velocidad Efectiva</div>
                <canvas id="chartVelocidadEfectiva" aria-label="Gr√°fico de velocidad efectiva por ciclo" role="img"></canvas>
                <div class="chart-subtitle">Velocidad √ó Comprensi√≥n</div>
              </div>
            </div>
            
            <!-- M√©tricas del Ciclo Actual -->
            <div style="margin-top: 24px;">
              <h4 style="font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 12px;">
                üìå Ciclo Actual - Detalle
              </h4>
              <div class="metrics-grid" id="metricsLectura">
                <div class="metric-card">
                  <div class="metric-value" id="metricVS">--</div>
                  <div class="metric-label">Velocidad Simple <span class="info-icon" title="Palabras le√≠das por minuto">?</span></div>
                  <span class="metric-badge badge-good">PPM</span>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="metricComprension">--%</div>
                  <div class="metric-label">Comprensi√≥n <span class="info-icon" title="Porcentaje de respuestas correctas">?</span></div>
                  <span class="metric-badge badge-good" id="statusComprension">Adecuado</span>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="metricVE">--</div>
                  <div class="metric-label" id="labelVE">Velocidad Efectiva <span class="info-icon" title="Velocidad √ó Comprensi√≥n">?</span></div>
                  <span class="metric-badge badge-good" id="statusVE">Adecuado</span>
                </div>
              </div>
            </div>
            <div id="lecturaDetalle"></div>
          </div>
          
          <!-- Creatividad Section -->
          <div class="section" id="sectionCreatividad">
            <div class="section-header">
              <h3 class="section-title">
                <span class="section-icon creatividad">üé®</span>
                Creatividad
              </h3>
            </div>
            
            <!-- Gr√°fico de Creatividad -->
            <div class="chart-container chart-full-width" style="margin-bottom: 20px;">
              <div class="chart-title">üìä Calificaci√≥n por Ciclo</div>
              <canvas id="chartCreatividad" aria-label="Gr√°fico de calificaciones de creatividad por ciclo" role="img" style="max-height: 250px;"></canvas>
              <div class="chart-subtitle">Calificaci√≥n del docente (0-100%) en cada ciclo completado</div>
            </div>
            
            <div id="creatividadContent">
              <div class="empty-state">
                <div class="empty-state-icon">üé®</div>
                <p>No hay actividad de creatividad en este ciclo</p>
              </div>
            </div>
          </div>
          
          <!-- Ejercicios Section (Habilidades) -->
          <div class="section" id="sectionEjercicios">
            <div class="section-header">
              <h3 class="section-title">
                <span class="section-icon ejercicios">üéÆ</span>
                Habilidades Cognitivas
              </h3>
            </div>
            
            <!-- Tarjetas de Habilidades con Gr√°ficos Expandibles -->
            <div class="habilidades-grid" id="habilidadesGrid">
              <!-- Se generan din√°micamente -->
            </div>
            
            <div id="ejerciciosContent" style="margin-top: 20px;">
              <div class="empty-state">
                <div class="empty-state-icon">üéÆ</div>
                <p>No hay ejercicios digitales en este ciclo</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Tab: Comparativo -->
        <div id="tabComparativo" class="tab-content hidden">
          <div class="section">
            <div class="section-header">
              <h3 class="section-title">Comparativo vs. Compa√±eros de Grado</h3>
            </div>
            <div id="comparativoContent">
              <div class="empty-state">
                <p>Cargando comparativo...</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Tab: Historial -->
        <div id="tabHistorial" class="tab-content hidden">
          <div class="section">
            <div class="section-header">
              <h3 class="section-title">Historial de Progreso</h3>
            </div>
            <div id="historialContent"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import { requireRole, getUser, logout } from '../auth/auth.core.js';
    import { 
      AccesoGuardianAPI, 
      BenchmarksAPI,
      ResumenCicloAPI,
      LecturaDetalleAPI,
      CreatividadDetalleAPI,
      EjerciciosDetalleAPI,
      ComparativosAPI,
      HabilidadesAPI,
      DESCRIPCIONES_METRICAS 
    } from './guardian.api.js';
    
    // ============================================
    // DESCRIPCIONES DE HABILIDADES
    // ============================================
    const HABILIDADES_DESCRIPCIONES = {
      'atencion': { nombre: 'Atenci√≥n', descripcion: 'Qu√© tan bien puede concentrarse sin distraerse', icono: 'üéØ' },
      'memoria': { nombre: 'Memoria', descripcion: 'Qu√© tan bien recuerda informaci√≥n y patrones', icono: 'üß†' },
      'logica': { nombre: 'L√≥gica', descripcion: 'Qu√© tan bien encuentra patrones y resuelve puzzles', icono: 'üî¢' },
      'velocidad': { nombre: 'Velocidad de Procesamiento', descripcion: 'Qu√© tan r√°pido identifica y responde a informaci√≥n', icono: '‚ö°' },
      'percepcion': { nombre: 'Percepci√≥n Visual', descripcion: 'Qu√© tan bien identifica formas, colores y patrones', icono: 'üëÅÔ∏è' },
      'coordinacion': { nombre: 'Coordinaci√≥n', descripcion: 'Qu√© tan bien controla movimientos precisos', icono: 'ü§π' },
      'resolucion': { nombre: 'Resoluci√≥n de Problemas', descripcion: 'Qu√© tan bien enfrenta y resuelve desaf√≠os nuevos', icono: 'üí°' },
      'planificacion': { nombre: 'Planificaci√≥n', descripcion: 'Qu√© tan bien organiza pasos para lograr un objetivo', icono: 'üìã' },
      'creatividad_digital': { nombre: 'Creatividad Digital', descripcion: 'Qu√© tan original y creativo es al resolver tareas', icono: 'üé®' },
      'calculo': { nombre: 'C√°lculo Mental', descripcion: 'Qu√© tan bien hace operaciones de n√∫meros en su mente', icono: 'üî¢' }
    };
    
    const loadingState = document.getElementById('loadingState');
    const mainContent = document.getElementById('mainContent');
    
    let estudianteSeleccionado = null;
    let estudianteGrado = null;
    let estudianteGradoNumero = null;
    let cicloActual = 1;
    let totalCiclos = 1;
    let datosResumen = [];
    let benchmarks = null;
    let habilidadesDB = {};
    
    // Verificar autenticaci√≥n
    const user = getUser();
    
    if (!user) {
      loadingState.innerHTML = '<p>Redirigiendo al login...</p>';
      setTimeout(() => {
        window.location.href = '../index.html';
      }, 1000);
    } else {
      inicializar();
    }
    
    async function inicializar() {
      try {
        // Cargar habilidades de la DB
        try {
          const habilidades = await HabilidadesAPI.listar();
          habilidades?.forEach(h => {
            habilidadesDB[h.codigo] = h;
          });
        } catch (e) {
          console.log('Usando habilidades predefinidas');
        }
        
        // Cargar estudiantes asociados
        let estudiantes = await AccesoGuardianAPI.obtenerEstudiantes(user.id);
        
        if ((!estudiantes || estudiantes.length === 0) && user.email) {
          estudiantes = await AccesoGuardianAPI.obtenerEstudiantesPorEmail(user.email);
        }
        
        loadingState.classList.add('hidden');
        mainContent.classList.remove('hidden');
        
        renderizarEstudiantes(estudiantes);
        
        // Setup tabs
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            cambiarTab(tabName);
          });
        });
        
        // Logout
        document.getElementById('btnLogout').addEventListener('click', () => {
          if (confirm('¬øCerrar sesi√≥n?')) {
            logout();
          }
        });
        
      } catch (error) {
        console.error('Error inicializando:', error);
        loadingState.innerHTML = `<p style="color: #dc2626;">Error: ${error.message}</p>`;
      }
    }
    
    function renderizarEstudiantes(estudiantes) {
      const grid = document.getElementById('studentsGrid');
      
      if (!estudiantes || estudiantes.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üë®‚Äçüë©‚Äçüëß</div>
            <h3>Sin estudiantes asociados</h3>
            <p>No tienes estudiantes vinculados. Contacta al administrador.</p>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = estudiantes.map(est => {
        const iniciales = `${est.nombre?.charAt(0) || ''}${est.apellidos?.charAt(0) || ''}`.toUpperCase();
        return `
          <div class="student-card" onclick="seleccionarEstudiante('${est.id}')" data-id="${est.id}" data-grado="${est.grado || ''}">
            <div class="student-avatar">${iniciales}</div>
            <div class="student-info">
              <h3>${est.nombre} ${est.apellidos || ''}</h3>
              <p>${est.grado || 'Sin grado'} ‚Ä¢ ${est.codigo_estudiante || ''}</p>
            </div>
          </div>
        `;
      }).join('');
      
      if (estudiantes.length === 1) {
        seleccionarEstudiante(estudiantes[0].id);
      }
    }
    
    window.seleccionarEstudiante = async function(estudianteId) {
      document.querySelectorAll('.student-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.id === estudianteId);
      });
      
      estudianteSeleccionado = estudianteId;
      
      // Obtener grado del estudiante
      const card = document.querySelector(`.student-card[data-id="${estudianteId}"]`);
      const gradoText = card?.querySelector('.student-info p')?.textContent || '';
      estudianteGrado = extraerGrado(gradoText);
      estudianteGradoNumero = gradoText.match(/\d+/)?.[0] || '';
      
      // Mostrar grado en el badge
      const gradeBadge = document.getElementById('gradeBadge');
      if (gradeBadge && estudianteGradoNumero) {
        gradeBadge.textContent = `Grado ${estudianteGradoNumero}`;
      }
      
      document.getElementById('dashboardContent').classList.remove('hidden');
      
      await cargarDatosEstudiante();
    };
    
    async function cargarDatosEstudiante() {
      if (!estudianteSeleccionado) return;
      
      try {
        // Cargar benchmarks
        if (estudianteGrado) {
          benchmarks = await BenchmarksAPI.obtenerPorGrado(estudianteGrado);
        }
        
        // Cargar historial
        datosResumen = await ResumenCicloAPI.obtenerHistorial(estudianteSeleccionado) || [];
        
        // Cargar datos directamente de sesiones si no hay res√∫menes
        if (datosResumen.length === 0) {
          const [historialLectura, historialCreatividad, historialEjercicios] = await Promise.all([
            LecturaDetalleAPI.obtenerHistorial(estudianteSeleccionado),
            CreatividadDetalleAPI.obtenerHistorial(estudianteSeleccionado),
            EjerciciosDetalleAPI.obtenerHistorial(estudianteSeleccionado)
          ]);
          
          const ciclosMap = {};
          
          historialLectura?.forEach(s => {
            const cicloNum = s.ciclos_lectura?.numero_ciclo || 1;
            if (!ciclosMap[cicloNum]) ciclosMap[cicloNum] = { ciclo_numero: cicloNum };
            ciclosMap[cicloNum].lectura_completada = true;
            ciclosMap[cicloNum].lectura_velocidad_simple = s.velocidad_simple;
            ciclosMap[cicloNum].lectura_comprension = s.porcentaje_comprension;
            ciclosMap[cicloNum].lectura_velocidad_efectiva = s.velocidad_efectiva;
            ciclosMap[cicloNum].lectura_aciertos_vocabulario = s.aciertos_vocabulario;
            ciclosMap[cicloNum].lectura_total_vocabulario = s.total_vocabulario;
            ciclosMap[cicloNum].lectura_sesion_id = s.id;
          });
          
          historialCreatividad?.forEach(s => {
            const cicloNum = s.ciclos_creatividad?.numero_ciclo || 1;
            if (!ciclosMap[cicloNum]) ciclosMap[cicloNum] = { ciclo_numero: cicloNum };
            ciclosMap[cicloNum].creatividad_completada = true;
            ciclosMap[cicloNum].creatividad_calificacion = s.calificacion_docente;
            ciclosMap[cicloNum].creatividad_sesion_id = s.id;
          });
          
          historialEjercicios?.forEach(r => {
            const cicloNum = r.juegos_ejercicios?.ciclos_ejercicios?.numero_ciclo || 1;
            if (!ciclosMap[cicloNum]) ciclosMap[cicloNum] = { ciclo_numero: cicloNum };
            if (!ciclosMap[cicloNum].ejercicios_resultados) ciclosMap[cicloNum].ejercicios_resultados = [];
            ciclosMap[cicloNum].ejercicios_resultados.push(r);
          });
          
          Object.keys(ciclosMap).forEach(cicloNum => {
            const ciclo = ciclosMap[cicloNum];
            if (ciclo.ejercicios_resultados?.length > 0) {
              const resultados = ciclo.ejercicios_resultados;
              ciclo.ejercicios_promedio = resultados.reduce((sum, r) => {
                const meta = r.juegos_ejercicios?.meta_objetivo || 1;
                return sum + Math.min((r.resultado_obtenido / meta) * 100, 100);
              }, 0) / resultados.length;
              ciclo.ejercicios_completados = resultados.length;
              ciclo.ejercicios_metas_alcanzadas = resultados.filter(r => r.meta_alcanzada).length;
            }
          });
          
          datosResumen = Object.values(ciclosMap).sort((a, b) => b.ciclo_numero - a.ciclo_numero);
        }
        
        totalCiclos = datosResumen.length > 0 ? Math.max(...datosResumen.map(d => d.ciclo_numero)) : 1;
        cicloActual = totalCiclos;
        
        const alertas = await ResumenCicloAPI.obtenerAlertas(estudianteSeleccionado);
        renderizarAlertas(alertas);
        
        await actualizarResumenRapido();
        actualizarNavegadorCiclo();
        await cargarDetalleCiclo();
        
        // Inicializar gr√°ficos despu√©s de cargar datos
        inicializarGraficos();
        
      } catch (error) {
        console.error('Error cargando datos:', error);
      }
    }
    
    function extraerGrado(texto) {
      const gradosMap = {
        'tercero': 'tercero', '3': 'tercero', '3¬∞': 'tercero',
        'cuarto': 'cuarto', '4': 'cuarto', '4¬∞': 'cuarto',
        'quinto': 'quinto', '5': 'quinto', '5¬∞': 'quinto',
        'sexto': 'sexto', '6': 'sexto', '6¬∞': 'sexto',
        'septimo': 'septimo', '7': 'septimo', '7¬∞': 'septimo',
        'octavo': 'octavo', '8': 'octavo', '8¬∞': 'octavo',
        'noveno': 'noveno', '9': 'noveno', '9¬∞': 'noveno',
        'decimo': 'decimo', '10': 'decimo', '10¬∞': 'decimo',
        'undecimo': 'undecimo', '11': 'undecimo', '11¬∞': 'undecimo'
      };
      const palabras = texto.toLowerCase().split(/[\s‚Ä¢]+/);
      for (const palabra of palabras) {
        if (gradosMap[palabra]) return gradosMap[palabra];
      }
      return null;
    }
    
    async function actualizarResumenRapido() {
      const ultimoCiclo = datosResumen.find(d => d.ciclo_numero === totalCiclos) || {};
      
      // Lectura
      const ve = ultimoCiclo.lectura_velocidad_efectiva;
      document.getElementById('summaryLecturaValue').textContent = ve ? Math.round(ve) : '--';
      document.getElementById('summaryComprension').textContent = ultimoCiclo.lectura_comprension ? `${Math.round(ultimoCiclo.lectura_comprension)}%` : '--%';
      document.getElementById('summaryVelocidad').textContent = ultimoCiclo.lectura_velocidad_simple ? `${Math.round(ultimoCiclo.lectura_velocidad_simple)} PPM` : '-- PPM';
      
      const trendLectura = document.getElementById('trendLectura');
      if (ultimoCiclo.tendencia_lectura === 'mejora') {
        trendLectura.className = 'summary-trend trend-up';
        trendLectura.textContent = '‚Üë Mejorando';
      } else if (ultimoCiclo.tendencia_lectura === 'baja') {
        trendLectura.className = 'summary-trend trend-down';
        trendLectura.textContent = '‚Üì Bajando';
      } else {
        trendLectura.className = 'summary-trend trend-same';
        trendLectura.textContent = '‚Üí Estable';
      }
      
      // Creatividad
      let creatividad = ultimoCiclo.creatividad_calificacion;
      if (!creatividad) {
        try {
          const historialCreatividad = await CreatividadDetalleAPI.obtenerHistorial(estudianteSeleccionado);
          const ultimaCreatividad = historialCreatividad?.find(s => s.ciclos_creatividad?.numero_ciclo === totalCiclos);
          if (ultimaCreatividad?.calificacion_docente) {
            creatividad = ultimaCreatividad.calificacion_docente;
          }
        } catch (e) { /* silencioso */ }
      }
      document.getElementById('summaryCreatividadValue').textContent = creatividad ? `${Math.round(creatividad)}%` : '--%';
      
      // Ejercicios
      let ejercicios = ultimoCiclo.ejercicios_promedio;
      let ejerciciosCompletados = ultimoCiclo.ejercicios_completados || 0;
      let ejerciciosMetas = ultimoCiclo.ejercicios_metas_alcanzadas || 0;
      
      if (!ejercicios && ejerciciosCompletados === 0) {
        try {
          const historialEjercicios = await EjerciciosDetalleAPI.obtenerHistorial(estudianteSeleccionado);
          const ejerciciosCiclo = historialEjercicios?.filter(r => r.juegos_ejercicios?.ciclos_ejercicios?.numero_ciclo === totalCiclos) || [];
          if (ejerciciosCiclo.length > 0) {
            ejerciciosCompletados = ejerciciosCiclo.length;
            ejerciciosMetas = ejerciciosCiclo.filter(r => r.meta_alcanzada).length;
            ejercicios = ejerciciosCiclo.reduce((sum, r) => {
              const meta = r.juegos_ejercicios?.meta_objetivo || 1;
              return sum + Math.min((r.resultado_obtenido / meta) * 100, 100);
            }, 0) / ejerciciosCiclo.length;
          }
        } catch (e) { /* silencioso */ }
      }
      
      document.getElementById('summaryEjerciciosValue').textContent = ejercicios ? `${Math.round(ejercicios)}%` : '--%';
      document.getElementById('summaryMetas').textContent = `${ejerciciosMetas}/${ejerciciosCompletados}`;
    }
    
    function actualizarNavegadorCiclo() {
      document.getElementById('cycleIndicator').textContent = `Ciclo ${cicloActual} de ${totalCiclos}`;
      document.getElementById('btnCicloAnterior').disabled = cicloActual <= 1;
      document.getElementById('btnCicloSiguiente').disabled = cicloActual >= totalCiclos;
    }
    
    window.cicloAnterior = function() {
      if (cicloActual > 1) {
        cicloActual--;
        actualizarNavegadorCiclo();
        cargarDetalleCiclo();
      }
    };
    
    window.cicloSiguiente = function() {
      if (cicloActual < totalCiclos) {
        cicloActual++;
        actualizarNavegadorCiclo();
        cargarDetalleCiclo();
      }
    };
    
    async function cargarDetalleCiclo() {
      const datosCiclo = datosResumen.find(d => d.ciclo_numero === cicloActual) || {};
      
      // Actualizar label de velocidad efectiva con grado
      const labelVE = document.getElementById('labelVE');
      if (labelVE && estudianteGradoNumero) {
        labelVE.innerHTML = `Velocidad Efectiva (G${estudianteGradoNumero}) <span class="info-icon" title="Velocidad √ó Comprensi√≥n">?</span>`;
      }
      
      // M√©tricas de lectura
      document.getElementById('metricVS').textContent = datosCiclo.lectura_velocidad_simple ? Math.round(datosCiclo.lectura_velocidad_simple) : '--';
      document.getElementById('metricComprension').textContent = datosCiclo.lectura_comprension ? `${Math.round(datosCiclo.lectura_comprension)}%` : '--%';
      document.getElementById('metricVE').textContent = datosCiclo.lectura_velocidad_efectiva ? Math.round(datosCiclo.lectura_velocidad_efectiva) : '--';
      
      actualizarEstadoMetrica('statusComprension', datosCiclo.lectura_comprension, 'comprension');
      actualizarEstadoMetrica('statusVE', datosCiclo.lectura_velocidad_efectiva, 've');
      
      await cargarDetalleLectura(datosCiclo);
      await cargarDetalleCreatividad(datosCiclo);
      await cargarDetalleEjercicios(datosCiclo);
    }
    
    async function cargarDetalleLectura(datosCiclo) {
      const container = document.getElementById('lecturaDetalle');
      
      if (!datosCiclo.lectura_completada) {
        container.innerHTML = '<div class="detail-card"><p style="color: var(--gray-500);">No hay sesi√≥n de lectura completada en este ciclo.</p></div>';
        return;
      }
      
      let contenido = '<div class="detail-card"><h4>üìñ Detalles de la Sesi√≥n</h4>';
      let sesionCompleta = null;
      
      if (datosCiclo.lectura_sesion_id) {
        try {
          sesionCompleta = await LecturaDetalleAPI.obtenerSesionCompleta(datosCiclo.lectura_sesion_id);
          if (sesionCompleta) {
            contenido += `
              <div class="detail-row"><span>T√≠tulo</span><span>${sesionCompleta.ciclos_lectura?.titulo || 'N/A'}</span></div>
              <div class="detail-row"><span>Autor</span><span>${sesionCompleta.ciclos_lectura?.autor || 'N/A'}</span></div>
              <div class="detail-row"><span>Fecha</span><span>${sesionCompleta.fecha_fin_sesion ? new Date(sesionCompleta.fecha_fin_sesion).toLocaleDateString('es-ES') : 'N/A'}</span></div>
            `;
          }
        } catch (e) {
          console.error('Error cargando sesi√≥n:', e);
        }
        
        contenido += `
          <div style="margin-top: 16px;">
            <button onclick="verEjercicioLectura('${datosCiclo.lectura_sesion_id}')" class="btn btn-primary">
              üëÅÔ∏è Ver Ejercicio Completo
            </button>
          </div>
        `;
      }
      
      // Vocabulario - Recalcular desde JSONB para mostrar datos reales
      if (sesionCompleta) {
        const vocabReal = calcularVocabularioReal(sesionCompleta);
        if (vocabReal.total > 0) {
          const pct = Math.round((vocabReal.aciertos / vocabReal.total) * 100);
          const color = pct >= 70 ? 'var(--success)' : pct >= 50 ? 'var(--warning)' : 'var(--danger)';
          contenido += `
            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
              <h4 style="margin-bottom: 12px; font-size: 14px; font-weight: 600; color: var(--gray-700);">üìö Evaluaci√≥n de Vocabulario</h4>
              <div class="detail-row"><span>Aciertos</span><span>${vocabReal.aciertos} de ${vocabReal.total}</span></div>
              <div class="detail-row"><span>Porcentaje</span><span style="color: ${color}; font-weight: 600;">${pct}%</span></div>
            </div>
          `;
        }
      } else if (datosCiclo.lectura_total_vocabulario > 0) {
        // Fallback si no hay sesi√≥n completa
        const pct = Math.round((datosCiclo.lectura_aciertos_vocabulario / datosCiclo.lectura_total_vocabulario) * 100);
        const color = pct >= 70 ? 'var(--success)' : pct >= 50 ? 'var(--warning)' : 'var(--danger)';
        contenido += `
          <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
            <h4 style="margin-bottom: 12px; font-size: 14px; font-weight: 600; color: var(--gray-700);">üìö Evaluaci√≥n de Vocabulario</h4>
            <div class="detail-row"><span>Aciertos</span><span>${datosCiclo.lectura_aciertos_vocabulario} de ${datosCiclo.lectura_total_vocabulario}</span></div>
            <div class="detail-row"><span>Porcentaje</span><span style="color: ${color}; font-weight: 600;">${pct}%</span></div>
          </div>
        `;
      }
      
      contenido += '</div>';
      container.innerHTML = contenido;
    }
    
    /**
     * Recalcula los aciertos de vocabulario desde el JSONB respuestas_vocabulario
     * comparando con las respuestas correctas del ciclo.
     * Esto asegura que se muestren los datos REALES, no los agregados que podr√≠an estar desactualizados.
     */
    function calcularVocabularioReal(sesion) {
      const respuestas = sesion.respuestas_vocabulario || {};
      const ciclo = sesion.ciclos_lectura;
      
      // Intentar obtener preguntas de vocabulario del contenido del ciclo
      let preguntas = [];
      if (ciclo?.contenido) {
        let contenidoObj = ciclo.contenido;
        if (typeof contenidoObj === 'string') {
          try { contenidoObj = JSON.parse(contenidoObj); } catch (e) { contenidoObj = {}; }
        }
        preguntas = contenidoObj.vocabulary_questions || [];
      }
      
      // Si no hay preguntas en el ciclo, usar los campos agregados como fallback
      if (preguntas.length === 0) {
        return {
          aciertos: sesion.aciertos_vocabulario || 0,
          total: sesion.total_vocabulario || 0
        };
      }
      
      // Recalcular aciertos comparando respuestas con las correctas
      let aciertos = 0;
      preguntas.forEach(q => {
        const respuestaUsuario = respuestas[q.qid];
        if (respuestaUsuario !== undefined && respuestaUsuario === q.answer) {
          aciertos++;
        }
      });
      
      return {
        aciertos,
        total: preguntas.length
      };
    }
    
    async function cargarDetalleCreatividad(datosCiclo) {
      const container = document.getElementById('creatividadContent');
      
      if (!datosCiclo.creatividad_completada) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üé®</div><p>No hay actividad de creatividad en este ciclo</p></div>';
        return;
      }
      
      let contenido = '<div class="detail-card"><h4>üé® Trabajo Creativo</h4>';
      
      if (datosCiclo.creatividad_sesion_id) {
        try {
          const sesion = await CreatividadDetalleAPI.obtenerSesionCompleta(datosCiclo.creatividad_sesion_id);
          if (sesion) {
            contenido += `
              <div class="detail-row"><span>T√≠tulo</span><span>${sesion.ciclos_creatividad?.titulo || 'N/A'}</span></div>
              <div class="detail-row"><span>Calificaci√≥n</span><span style="font-size: 20px; font-weight: 700; color: var(--primary);">${datosCiclo.creatividad_calificacion ? Math.round(datosCiclo.creatividad_calificacion) : '--'}%</span></div>
              <div class="detail-row"><span>Fecha</span><span>${sesion.fecha_fin_sesion ? new Date(sesion.fecha_fin_sesion).toLocaleDateString('es-ES') : 'N/A'}</span></div>
            `;
            
            contenido += `
              <div style="margin-top: 16px;">
                <button onclick="verDesafioCreatividad('${datosCiclo.creatividad_sesion_id}')" class="btn btn-primary" style="background: #7c3aed;">
                  üé® Ver Desaf√≠o Completo
                </button>
              </div>
            `;
          }
        } catch (e) {
          console.error('Error cargando creatividad:', e);
        }
      }
      
      contenido += '</div>';
      container.innerHTML = contenido;
    }
    
    async function cargarDetalleEjercicios(datosCiclo) {
      const container = document.getElementById('ejerciciosContent');
      
      if (!datosCiclo.ejercicios_resultados || datosCiclo.ejercicios_resultados.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéÆ</div><p>No hay ejercicios digitales en este ciclo</p></div>';
        return;
      }
      
      // Historial completo para gr√°ficos
      let historialCompleto = [];
      try {
        historialCompleto = await EjerciciosDetalleAPI.obtenerHistorial(estudianteSeleccionado) || [];
      } catch (e) { /* silencioso */ }
      
      // Agrupar por juego
      const juegosMap = {};
      datosCiclo.ejercicios_resultados.forEach(resultado => {
        const juegoId = resultado.juegos_ejercicios?.id;
        if (juegoId && !juegosMap[juegoId]) {
          juegosMap[juegoId] = { juego: resultado.juegos_ejercicios, resultados: [] };
        }
        if (juegoId) juegosMap[juegoId].resultados.push(resultado);
      });
      
      // Agregar historial
      historialCompleto.forEach(resultado => {
        const juegoId = resultado.juegos_ejercicios?.id;
        if (juegoId && juegosMap[juegoId]) {
          const yaExiste = juegosMap[juegoId].resultados.some(r => r.id === resultado.id);
          if (!yaExiste) juegosMap[juegoId].resultados.push(resultado);
        }
      });
      
      // Ordenar por fecha
      Object.values(juegosMap).forEach(({ resultados }) => {
        resultados.sort((a, b) => new Date(a.fecha_registro || 0) - new Date(b.fecha_registro || 0));
      });
      
      let html = '';
      
      Object.values(juegosMap).forEach(({ juego, resultados }) => {
        const ultimoRes = resultados[resultados.length - 1];
        const meta = juego?.meta_objetivo || 1;
        const rendimiento = Math.min((ultimoRes.resultado_obtenido / meta) * 100, 100);
        const tipoMeta = juego?.tipo_meta || 'puntos';
        const tipoMetaLabel = { puntos: 'Puntos', niveles: 'Niveles', tiempo: 'Tiempo', porcentaje: 'Porcentaje' }[tipoMeta] || tipoMeta;
        
        // Obtener habilidad
        const habilidadCodigo = juego?.habilidad_estimulada || '';
        const habilidadInfo = habilidadesDB[habilidadCodigo] || HABILIDADES_DESCRIPCIONES[habilidadCodigo.toLowerCase()] || null;
        const nombreHabilidad = habilidadInfo?.nombre || habilidadCodigo || 'No especificada';
        const descripcionHabilidad = habilidadInfo?.descripcion_padres || habilidadInfo?.descripcion || '';
        const iconoHabilidad = habilidadInfo?.icono || 'üß†';
        
        // Crear SVG del gr√°fico
        const maxY = Math.max(meta, ...resultados.map(r => r.resultado_obtenido || 0)) * 1.1;
        const width = 350;
        const height = 140;
        const padding = { top: 20, right: 20, bottom: 30, left: 45 };
        const graphWidth = width - padding.left - padding.right;
        const graphHeight = height - padding.top - padding.bottom;
        
        let svgContent = '';
        
        // Eje Y
        svgContent += `<line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${height - padding.bottom}" stroke="#e5e7eb" stroke-width="1"/>`;
        
        // Labels del eje Y
        const yLabels = [0, Math.round(maxY / 2), Math.round(maxY)];
        yLabels.forEach(val => {
          const y = height - padding.bottom - (val / maxY) * graphHeight;
          svgContent += `<text x="${padding.left - 8}" y="${y + 4}" fill="#9ca3af" font-size="10" text-anchor="end">${val}</text>`;
          svgContent += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#f3f4f6" stroke-width="1"/>`;
        });
        
        // L√≠nea de meta
        const yMeta = height - padding.bottom - (meta / maxY) * graphHeight;
        svgContent += `<line x1="${padding.left}" y1="${yMeta}" x2="${width - padding.right}" y2="${yMeta}" stroke="#7c3aed" stroke-width="2" stroke-dasharray="4,4" opacity="0.6"/>`;
        svgContent += `<text x="${width - padding.right + 5}" y="${yMeta + 4}" fill="#7c3aed" font-size="10" font-weight="600">Meta</text>`;
        
        // L√≠nea de progreso
        if (resultados.length > 1) {
          let path = '';
          resultados.forEach((r, i) => {
            const x = padding.left + (i / (resultados.length - 1)) * graphWidth;
            const y = height - padding.bottom - ((r.resultado_obtenido || 0) / maxY) * graphHeight;
            path += i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`;
          });
          svgContent += `<path d="${path}" stroke="#4f46e5" stroke-width="2" fill="none"/>`;
        }
        
        // Puntos
        resultados.forEach((r, i) => {
          const x = padding.left + (resultados.length > 1 ? (i / (resultados.length - 1)) * graphWidth : graphWidth / 2);
          const y = height - padding.bottom - ((r.resultado_obtenido || 0) / maxY) * graphHeight;
          const esUltimo = i === resultados.length - 1;
          svgContent += `<circle cx="${x}" cy="${y}" r="${esUltimo ? 5 : 3}" fill="${esUltimo ? '#4f46e5' : '#059669'}" stroke="white" stroke-width="2"/>`;
        });
        
        html += `
          <div class="exercise-card">
            <div class="exercise-header">
              <div>
                <div class="exercise-title">${juego?.nombre || 'Ejercicio'}</div>
                <span class="exercise-type">${tipoMetaLabel}</span>
              </div>
              <div class="skill-badge">
                <span class="skill-name">${iconoHabilidad} ${nombreHabilidad}</span>
                ${descripcionHabilidad ? `<span class="skill-description">${descripcionHabilidad}</span>` : ''}
              </div>
            </div>
            
            <div class="chart-wrapper">
              <div class="chart-title">üìà Progreso Hist√≥rico</div>
              <svg width="${width}" height="${height}" style="display: block; max-width: 100%;">
                ${svgContent}
              </svg>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 16px;">
              <div style="text-align: center;">
                <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">${ultimoRes.resultado_obtenido}</div>
                <div style="font-size: 12px; color: var(--gray-500);">Resultado</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 20px; font-weight: 700; color: ${rendimiento >= 80 ? 'var(--success)' : rendimiento >= 50 ? 'var(--warning)' : 'var(--danger)'};">${Math.round(rendimiento)}%</div>
                <div style="font-size: 12px; color: var(--gray-500);">Rendimiento</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 20px; font-weight: 700; color: ${ultimoRes.meta_alcanzada ? 'var(--success)' : 'var(--danger)'};">${ultimoRes.meta_alcanzada ? '‚úì' : '‚úó'}</div>
                <div style="font-size: 12px; color: var(--gray-500);">Meta: ${meta}</div>
              </div>
            </div>
            
            ${juego?.url_juego ? `
              <div style="margin-top: 16px;">
                <a href="${juego.url_juego}" target="_blank" class="btn btn-primary" style="background: #0891b2; text-decoration: none;">üéÆ Jugar</a>
              </div>
            ` : ''}
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // ============================================
    // MODAL: Ver Ejercicio de Lectura
    // ============================================
    window.verEjercicioLectura = async function(sesionId) {
      try {
        const sesion = await LecturaDetalleAPI.obtenerSesionCompleta(sesionId);
        if (!sesion) {
          alert('No se pudo cargar la sesi√≥n');
          return;
        }
        
        const ciclo = sesion.ciclos_lectura;
        let textoContenido = '';
        let questions = [];
        let vocabularyQuestions = [];
        let tituloTexto = ciclo?.titulo || '';
        let autorTexto = ciclo?.autor || '';
        
        // Debug: Ver estructura del contenido
        console.log('=== DEBUG CONTENIDO LECTURA ===');
        console.log('Ciclo completo:', ciclo);
        console.log('Tipo de contenido:', typeof ciclo?.contenido);
        console.log('Contenido raw:', ciclo?.contenido);
        
        // Parsear contenido - La estructura es: { reading: { text_excerpt, title, author... }, questions: [], vocabulary_questions: [] }
        if (ciclo?.contenido) {
          let contenidoObj = ciclo.contenido;
          
          // Si viene como string, parsearlo
          if (typeof contenidoObj === 'string') {
            try {
              contenidoObj = JSON.parse(contenidoObj);
            } catch (e) {
              console.error('Error parseando contenido:', e);
            }
          }
          
          // Extraer el texto completo de reading.text_excerpt (estructura principal)
          if (contenidoObj.reading && contenidoObj.reading.text_excerpt) {
            textoContenido = contenidoObj.reading.text_excerpt;
            tituloTexto = contenidoObj.reading.title || tituloTexto;
            autorTexto = contenidoObj.reading.author || autorTexto;
          } 
          // Fallbacks para otras posibles estructuras
          else if (contenidoObj.text_excerpt) {
            textoContenido = contenidoObj.text_excerpt;
          }
          else if (contenidoObj.text) {
            textoContenido = contenidoObj.text;
          }
          else if (contenidoObj.contenido) {
            textoContenido = contenidoObj.contenido;
          }
          
          // Obtener preguntas
          questions = contenidoObj.questions || [];
          vocabularyQuestions = contenidoObj.vocabulary_questions || [];
        }
        
        // Si a√∫n no hay texto, usar el resumen como √∫ltimo recurso
        if (!textoContenido || textoContenido.trim() === '') {
          textoContenido = ciclo?.resumen || 'Contenido no disponible';
          console.warn('Usando resumen como fallback - texto completo no encontrado');
        }
        
        console.log('Texto extra√≠do (primeros 200 chars):', textoContenido.substring(0, 200));
        console.log('Preguntas comprensi√≥n:', questions.length);
        console.log('Preguntas vocabulario:', vocabularyQuestions.length);
        console.log('=== FIN DEBUG ===');
        
        const respuestasEval = sesion.respuestas_evaluacion || {};
        const respuestasVocab = sesion.respuestas_vocabulario || {};
        
        // Generar HTML de preguntas
        const generarPreguntas = (preguntas, respuestas, titulo) => {
          if (!preguntas.length) return '';
          
          let html = `<div style="margin-top: 24px;"><h3 style="font-size: 16px; font-weight: 600; color: var(--gray-800); margin-bottom: 16px;">${titulo}</h3>`;
          
          preguntas.forEach((q, idx) => {
            const respuesta = respuestas[q.qid];
            const correcta = q.answer;
            const esCorrecta = respuesta === correcta;
            const opciones = q.options || [];
            
            html += `
              <div class="question-card">
                <div class="question-header">
                  <span class="question-status">${esCorrecta ? '‚úÖ' : '‚ùå'}</span>
                  <span class="question-text">${idx + 1}. ${q.stem || q.word || 'Pregunta ' + (idx + 1)}</span>
                </div>
                <div>
                  ${opciones.map((opt, i) => {
                    const esSeleccionada = respuesta === i;
                    const esCorrectaOpt = i === correcta;
                    let clase = '';
                    if (esCorrectaOpt) clase = 'correct';
                    else if (esSeleccionada && !esCorrectaOpt) clase = 'incorrect';
                    
                    return `
                      <div class="option-item ${clase}">
                        ${esCorrectaOpt ? '<span class="option-indicator">‚úì</span>' : esSeleccionada ? '<span class="option-indicator">‚úó</span>' : '<span style="width: 16px;"></span>'}
                        <span>${i + 1}. ${opt}</span>
                      </div>
                    `;
                  }).join('')}
                </div>
                ${q.justification ? `
                  <div class="justification-box">
                    <strong>üí° Justificaci√≥n:</strong> ${q.justification}
                  </div>
                ` : ''}
              </div>
            `;
          });
          
          return html + '</div>';
        };
        
        // Formatear el texto con p√°rrafos
        const textoFormateado = textoContenido
          .split(/\n\n+/)
          .filter(p => p.trim())
          .map(p => `<p style="margin-bottom: 16px; text-indent: 2em;">${p.trim()}</p>`)
          .join('');
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.id = 'modalLectura';
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2 class="modal-title">üìñ Ejercicio de Lectura</h2>
              <button class="modal-close" onclick="cerrarModal('modalLectura')">√ó</button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                <div><strong>T√≠tulo:</strong> ${tituloTexto || 'N/A'}</div>
                <div><strong>Autor:</strong> ${autorTexto || 'N/A'}</div>
                <div><strong>Velocidad:</strong> ${sesion.velocidad_simple ? Math.round(sesion.velocidad_simple) : '--'} PPM</div>
                <div><strong>Comprensi√≥n:</strong> ${sesion.porcentaje_comprension ? Math.round(sesion.porcentaje_comprension) : '--'}%</div>
              </div>
              
              <div style="margin-bottom: 24px;">
                <h3 style="font-size: 16px; font-weight: 600; color: var(--gray-800); margin-bottom: 12px;">üìÑ Texto Completo</h3>
                <div class="reading-text">${textoFormateado || textoContenido}</div>
              </div>
              
              ${generarPreguntas(questions, respuestasEval, 'üìù Comprensi√≥n Lectora')}
              ${generarPreguntas(vocabularyQuestions, respuestasVocab, 'üìö Vocabulario')}
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) cerrarModal('modalLectura');
        });
        
        document.addEventListener('keydown', function escHandler(e) {
          if (e.key === 'Escape') {
            cerrarModal('modalLectura');
            document.removeEventListener('keydown', escHandler);
          }
        });
        
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar el ejercicio');
      }
    };
    
    // ============================================
    // MODAL: Ver Desaf√≠o de Creatividad
    // ============================================
    window.verDesafioCreatividad = async function(sesionId) {
      try {
        const sesion = await CreatividadDetalleAPI.obtenerSesionCompleta(sesionId);
        if (!sesion) {
          alert('No se pudo cargar la sesi√≥n');
          return;
        }
        
        const ciclo = sesion.ciclos_creatividad;
        
        // Contenido del desaf√≠o
        let contenidoDesafio = '';
        let previewHtml = '';
        
        if (ciclo?.archivo_url) {
          if (ciclo.archivo_tipo === 'imagen') {
            previewHtml = `<div class="creativity-preview"><img src="${ciclo.archivo_url}" alt="Desaf√≠o de creatividad"/></div>`;
          } else if (ciclo.archivo_tipo === 'pdf') {
            previewHtml = `<div class="creativity-preview"><iframe src="${ciclo.archivo_url}" title="Desaf√≠o de creatividad"></iframe></div>`;
          }
        }
        
        if (ciclo?.instrucciones && ciclo.mostrar_instrucciones !== false) {
          contenidoDesafio = ciclo.instrucciones;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.id = 'modalCreatividad';
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2 class="modal-title">üé® Desaf√≠o de Creatividad</h2>
              <button class="modal-close" onclick="cerrarModal('modalCreatividad')">√ó</button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 20px;">
                <div><strong>T√≠tulo:</strong> ${ciclo?.titulo || 'N/A'}</div>
                <div style="margin-top: 8px;"><strong>Calificaci√≥n:</strong> <span style="font-size: 24px; font-weight: 700; color: var(--primary);">${sesion.calificacion_docente ? Math.round(sesion.calificacion_docente) : '--'}%</span></div>
                <div style="margin-top: 8px;"><strong>Fecha:</strong> ${sesion.fecha_fin_sesion ? new Date(sesion.fecha_fin_sesion).toLocaleDateString('es-ES') : 'N/A'}</div>
              </div>
              
              ${previewHtml ? `
                <div style="margin-bottom: 24px;">
                  <h3 style="font-size: 16px; font-weight: 600; color: var(--gray-800); margin-bottom: 12px;">üìã Desaf√≠o Original</h3>
                  ${previewHtml}
                </div>
              ` : ''}
              
              ${contenidoDesafio ? `
                <div style="margin-bottom: 24px;">
                  <h3 style="font-size: 16px; font-weight: 600; color: var(--gray-800); margin-bottom: 12px;">üìù Instrucciones</h3>
                  <div style="background: var(--gray-50); padding: 20px; border-radius: var(--radius); line-height: 1.8; color: var(--gray-700);">${contenidoDesafio}</div>
                </div>
              ` : ''}
              
              ${!previewHtml && !contenidoDesafio ? `
                <div class="empty-state">
                  <p>El contenido del desaf√≠o no est√° disponible para visualizaci√≥n.</p>
                </div>
              ` : ''}
              
              ${sesion.archivo_url ? `
                <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--gray-200);">
                  <h3 style="font-size: 16px; font-weight: 600; color: var(--gray-800); margin-bottom: 12px;">üìé Trabajo del Estudiante</h3>
                  <a href="${sesion.archivo_url}" target="_blank" class="btn btn-primary" style="background: #7c3aed; text-decoration: none;">Ver Trabajo Entregado</a>
                </div>
              ` : ''}
              
              ${sesion.comentarios_docente ? `
                <div class="justification-box" style="margin-top: 20px; background: #faf5ff; border-left-color: #7c3aed;">
                  <strong style="color: #7c3aed;">üí¨ Comentarios del Docente:</strong><br>${sesion.comentarios_docente}
                </div>
              ` : ''}
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) cerrarModal('modalCreatividad');
        });
        
        document.addEventListener('keydown', function escHandler(e) {
          if (e.key === 'Escape') {
            cerrarModal('modalCreatividad');
            document.removeEventListener('keydown', escHandler);
          }
        });
        
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar el desaf√≠o');
      }
    };
    
    window.cerrarModal = function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.remove();
    };
    
    function actualizarEstadoMetrica(elementId, valor, tipo) {
      const element = document.getElementById(elementId);
      if (!element || valor === undefined || valor === null) return;
      
      let estado = 'good';
      let texto = 'Adecuado';
      
      if (benchmarks) {
        const meta = tipo === 've' ? benchmarks.velocidad_efectiva_meta : benchmarks.comprension_meta;
        const excelente = tipo === 've' ? benchmarks.velocidad_efectiva_excelente : benchmarks.comprension_excelente;
        const minimo = tipo === 've' ? benchmarks.velocidad_efectiva_min : benchmarks.comprension_min;
        
        if (valor >= excelente) { estado = 'excellent'; texto = 'Excelente'; }
        else if (valor >= meta) { estado = 'good'; texto = 'Bueno'; }
        else if (valor >= minimo) { estado = 'needs-work'; texto = 'En desarrollo'; }
        else { estado = 'low'; texto = 'Necesita apoyo'; }
      }
      
      element.className = `metric-badge badge-${estado}`;
      element.textContent = texto;
    }
    
    function renderizarAlertas(alertas) {
      const container = document.getElementById('alertsContainer');
      if (!alertas || alertas.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = `
        <div style="background: var(--danger-light); border: 1px solid var(--danger); border-radius: var(--radius); padding: 16px; margin-bottom: 24px; display: flex; align-items: flex-start; gap: 12px;">
          <span style="font-size: 20px;">‚ö†Ô∏è</span>
          <div>
            <strong style="color: var(--danger);">Atenci√≥n requerida</strong>
            <p style="color: #991b1b; font-size: 14px; margin-top: 4px;">${alertas[0]?.mensaje || 'Hay √°reas que requieren atenci√≥n'}</p>
          </div>
        </div>
      `;
    }
    
    function cambiarTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      
      document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.remove('hidden');
      
      if (tabName === 'comparativo') cargarComparativo();
      else if (tabName === 'historial') cargarHistorial();
    }
    
    async function cargarComparativo() {
      const container = document.getElementById('comparativoContent');
      container.innerHTML = '<div class="empty-state"><p>Cargando comparativo...</p></div>';
      
      try {
        if (!estudianteGrado) {
          container.innerHTML = '<div class="empty-state"><p>No se pudo determinar el grado</p></div>';
          return;
        }
        
        const historialLectura = await LecturaDetalleAPI.obtenerHistorial(estudianteSeleccionado);
        
        if (!historialLectura || historialLectura.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>No hay datos de lectura para comparar</p></div>';
          return;
        }
        
        const promedioEstudianteVE = historialLectura.reduce((sum, s) => sum + (s.velocidad_efectiva || 0), 0) / historialLectura.length;
        const promedioEstudianteComprension = historialLectura.reduce((sum, s) => sum + (s.porcentaje_comprension || 0), 0) / historialLectura.length;
        
        const comparativo = await ComparativosAPI.obtenerComparativoGrado(estudianteSeleccionado, estudianteGrado);
        
        let promedioGradoVE = comparativo.grado?.velocidadEfectiva || benchmarks?.velocidad_efectiva_meta || 100;
        let promedioGradoComprension = comparativo.grado?.comprension || benchmarks?.comprension_meta || 70;
        
        const diferenciaVE = Math.round(promedioEstudianteVE - promedioGradoVE);
        const diferenciaComprension = Math.round(promedioEstudianteComprension - promedioGradoComprension);
        
        container.innerHTML = `
          <p style="color: var(--gray-600); font-size: 14px; margin-bottom: 24px;">
            Comparaci√≥n del rendimiento contra el promedio del grado ${estudianteGradoNumero}.
          </p>
          
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-value">${Math.round(promedioEstudianteVE)}</div>
              <div class="metric-label">Velocidad Efectiva (G${estudianteGradoNumero})</div>
              <div class="comparison-container">
                <div class="comparison-label">
                  <span>Promedio grado: ${Math.round(promedioGradoVE)}</span>
                  <span style="color: ${diferenciaVE >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">
                    ${diferenciaVE >= 0 ? '+' : ''}${diferenciaVE}
                  </span>
                </div>
                <div class="comparison-bar">
                  <div class="comparison-fill" style="width: ${Math.min((promedioEstudianteVE / (promedioGradoVE * 1.3)) * 100, 100)}%; background: ${diferenciaVE >= 0 ? 'var(--success)' : 'var(--warning)'}"></div>
                  <div class="comparison-marker" style="left: ${(promedioGradoVE / (promedioGradoVE * 1.3)) * 100}%;"></div>
                </div>
              </div>
            </div>
            
            <div class="metric-card">
              <div class="metric-value">${Math.round(promedioEstudianteComprension)}%</div>
              <div class="metric-label">Comprensi√≥n Promedio</div>
              <div class="comparison-container">
                <div class="comparison-label">
                  <span>Promedio grado: ${Math.round(promedioGradoComprension)}%</span>
                  <span style="color: ${diferenciaComprension >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">
                    ${diferenciaComprension >= 0 ? '+' : ''}${diferenciaComprension}%
                  </span>
                </div>
                <div class="comparison-bar">
                  <div class="comparison-fill" style="width: ${promedioEstudianteComprension}%; background: ${diferenciaComprension >= 0 ? 'var(--success)' : 'var(--warning)'}"></div>
                  <div class="comparison-marker" style="left: ${promedioGradoComprension}%;"></div>
                </div>
              </div>
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Error cargando comparativo:', error);
        container.innerHTML = `<div class="empty-state"><p>Error: ${error.message}</p></div>`;
      }
    }
    
    async function cargarHistorial() {
      const container = document.getElementById('historialContent');
      
      if (datosResumen.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No hay historial disponible</p></div>';
        return;
      }
      
      const historial = datosResumen.sort((a, b) => b.ciclo_numero - a.ciclo_numero);
      
      container.innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead>
              <tr style="background: var(--gray-50); border-bottom: 2px solid var(--gray-200);">
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--gray-700);">Ciclo</th>
                <th style="padding: 12px 16px; text-align: center; font-weight: 600; color: var(--gray-700);">Vel. Efectiva</th>
                <th style="padding: 12px 16px; text-align: center; font-weight: 600; color: var(--gray-700);">Comprensi√≥n</th>
                <th style="padding: 12px 16px; text-align: center; font-weight: 600; color: var(--gray-700);">Creatividad</th>
                <th style="padding: 12px 16px; text-align: center; font-weight: 600; color: var(--gray-700);">Ejercicios</th>
              </tr>
            </thead>
            <tbody>
              ${historial.map(h => `
                <tr style="border-bottom: 1px solid var(--gray-100);">
                  <td style="padding: 12px 16px; font-weight: 500;">Ciclo ${h.ciclo_numero}</td>
                  <td style="padding: 12px 16px; text-align: center;">
                    ${h.lectura_velocidad_efectiva ? Math.round(h.lectura_velocidad_efectiva) : '-'}
                    ${h.tendencia_lectura === 'mejora' ? '<span style="color: var(--success);">‚Üë</span>' : h.tendencia_lectura === 'baja' ? '<span style="color: var(--danger);">‚Üì</span>' : ''}
                  </td>
                  <td style="padding: 12px 16px; text-align: center;">${h.lectura_comprension ? Math.round(h.lectura_comprension) + '%' : '-'}</td>
                  <td style="padding: 12px 16px; text-align: center;">${h.creatividad_calificacion ? Math.round(h.creatividad_calificacion) + '%' : '-'}</td>
                  <td style="padding: 12px 16px; text-align: center;">${h.ejercicios_promedio ? Math.round(h.ejercicios_promedio) + '%' : '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    window.exportarPDF = function() {
      alert('Funci√≥n de exportaci√≥n a PDF pr√≥ximamente disponible.');
    };
    
    // ============================================
    // GR√ÅFICOS CON CHART.JS
    // ============================================
    
    let chartInstances = {};
    
    function destruirGraficos() {
      Object.values(chartInstances).forEach(chart => {
        if (chart) chart.destroy();
      });
      chartInstances = {};
    }
    
    function inicializarGraficos() {
      destruirGraficos();
      
      if (datosResumen.length === 0) return;
      
      // Ordenar por ciclo
      const datosOrdenados = [...datosResumen].sort((a, b) => a.ciclo_numero - b.ciclo_numero);
      const labels = datosOrdenados.map(d => `Ciclo ${d.ciclo_numero}`);
      
      // Configuraci√≥n com√∫n para gr√°ficos
      const configBase = {
        type: 'line',
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.95)',
              titleColor: '#1f2937',
              bodyColor: '#4b5563',
              borderColor: '#e5e7eb',
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              callbacks: {
                title: (items) => items[0]?.label || '',
                label: (item) => `${item.dataset.label}: ${item.formattedValue}`
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: '#6b7280', font: { size: 11 } }
            },
            y: {
              beginAtZero: true,
              grid: { color: '#f3f4f6' },
              ticks: { color: '#6b7280', font: { size: 11 } }
            }
          },
          elements: {
            point: {
              radius: 6,
              hoverRadius: 8,
              backgroundColor: '#fff',
              borderWidth: 3
            },
            line: {
              tension: 0.3,
              borderWidth: 3
            }
          }
        }
      };
      
      // 1. Gr√°fico Velocidad Simple
      const ctxVS = document.getElementById('chartVelocidadSimple');
      if (ctxVS) {
        const datosVS = datosOrdenados.map(d => d.lectura_velocidad_simple || null);
        chartInstances.velocidadSimple = new Chart(ctxVS, {
          ...configBase,
          data: {
            labels,
            datasets: [{
              label: 'Velocidad Simple (PPM)',
              data: datosVS,
              borderColor: '#4f46e5',
              pointBorderColor: '#4f46e5',
              fill: true,
              backgroundColor: 'rgba(79, 70, 229, 0.1)'
            }]
          },
          options: {
            ...configBase.options,
            onClick: (evt, elements) => {
              if (elements.length > 0) {
                const idx = elements[0].index;
                const cicloNum = datosOrdenados[idx].ciclo_numero;
                navegarACiclo(cicloNum);
              }
            }
          }
        });
      }
      
      // 2. Gr√°fico Comprensi√≥n
      const ctxC = document.getElementById('chartComprension');
      if (ctxC) {
        const datosC = datosOrdenados.map(d => d.lectura_comprension || null);
        chartInstances.comprension = new Chart(ctxC, {
          ...configBase,
          data: {
            labels,
            datasets: [{
              label: 'Comprensi√≥n (%)',
              data: datosC,
              borderColor: '#059669',
              pointBorderColor: '#059669',
              fill: true,
              backgroundColor: 'rgba(5, 150, 105, 0.1)'
            }]
          },
          options: {
            ...configBase.options,
            scales: {
              ...configBase.options.scales,
              y: {
                ...configBase.options.scales.y,
                max: 100,
                ticks: {
                  ...configBase.options.scales.y.ticks,
                  callback: (val) => val + '%'
                }
              }
            },
            onClick: (evt, elements) => {
              if (elements.length > 0) {
                const idx = elements[0].index;
                const cicloNum = datosOrdenados[idx].ciclo_numero;
                navegarACiclo(cicloNum);
              }
            }
          }
        });
      }
      
      // 3. Gr√°fico Velocidad Efectiva
      const ctxVE = document.getElementById('chartVelocidadEfectiva');
      if (ctxVE) {
        const datosVE = datosOrdenados.map(d => d.lectura_velocidad_efectiva || null);
        chartInstances.velocidadEfectiva = new Chart(ctxVE, {
          ...configBase,
          data: {
            labels,
            datasets: [{
              label: 'Velocidad Efectiva',
              data: datosVE,
              borderColor: '#7c3aed',
              pointBorderColor: '#7c3aed',
              fill: true,
              backgroundColor: 'rgba(124, 58, 237, 0.1)'
            }]
          },
          options: {
            ...configBase.options,
            onClick: (evt, elements) => {
              if (elements.length > 0) {
                const idx = elements[0].index;
                const cicloNum = datosOrdenados[idx].ciclo_numero;
                navegarACiclo(cicloNum);
              }
            }
          }
        });
      }
      
      // 4. Gr√°fico Creatividad
      const ctxCreat = document.getElementById('chartCreatividad');
      if (ctxCreat) {
        const datosCreat = datosOrdenados.map(d => d.creatividad_calificacion || null);
        chartInstances.creatividad = new Chart(ctxCreat, {
          ...configBase,
          data: {
            labels,
            datasets: [{
              label: 'Calificaci√≥n (%)',
              data: datosCreat,
              borderColor: '#7c3aed',
              pointBorderColor: '#7c3aed',
              fill: true,
              backgroundColor: 'rgba(124, 58, 237, 0.1)',
              spanGaps: false
            }]
          },
          options: {
            ...configBase.options,
            scales: {
              ...configBase.options.scales,
              y: {
                ...configBase.options.scales.y,
                max: 100,
                ticks: {
                  ...configBase.options.scales.y.ticks,
                  callback: (val) => val + '%'
                }
              }
            },
            onClick: (evt, elements) => {
              if (elements.length > 0) {
                const idx = elements[0].index;
                const cicloNum = datosOrdenados[idx].ciclo_numero;
                navegarACiclo(cicloNum);
              }
            }
          }
        });
      }
      
      // 5. Tarjetas de Habilidades
      inicializarTarjetasHabilidades(datosOrdenados);
    }
    
    function navegarACiclo(cicloNum) {
      cicloActual = cicloNum;
      actualizarNavegadorCiclo();
      cargarDetalleCiclo();
    }
    
    async function inicializarTarjetasHabilidades(datosOrdenados) {
      const container = document.getElementById('habilidadesGrid');
      if (!container) return;
      
      // Obtener historial completo de ejercicios
      let historialEjercicios = [];
      try {
        historialEjercicios = await EjerciciosDetalleAPI.obtenerHistorial(estudianteSeleccionado) || [];
      } catch (e) {
        console.error('Error cargando historial ejercicios:', e);
      }
      
      if (historialEjercicios.length === 0) {
        container.innerHTML = '<p style="color: var(--gray-500); text-align: center; padding: 20px;">No hay datos de ejercicios disponibles</p>';
        return;
      }
      
      // Agrupar por habilidad
      const habilidadesMap = {};
      historialEjercicios.forEach(resultado => {
        const habilidadCodigo = resultado.juegos_ejercicios?.habilidad_estimulada;
        if (!habilidadCodigo) return;
        
        if (!habilidadesMap[habilidadCodigo]) {
          habilidadesMap[habilidadCodigo] = {
            codigo: habilidadCodigo,
            info: habilidadesDB[habilidadCodigo] || { nombre: habilidadCodigo, descripcion: '', icono: 'üß†' },
            resultados: [],
            porCiclo: {}
          };
        }
        
        const cicloNum = resultado.juegos_ejercicios?.ciclos_ejercicios?.numero_ciclo;
        if (cicloNum) {
          if (!habilidadesMap[habilidadCodigo].porCiclo[cicloNum]) {
            habilidadesMap[habilidadCodigo].porCiclo[cicloNum] = [];
          }
          const meta = resultado.juegos_ejercicios?.meta_objetivo || 1;
          const pct = Math.min((resultado.resultado_obtenido / meta) * 100, 100);
          habilidadesMap[habilidadCodigo].porCiclo[cicloNum].push(pct);
        }
        
        habilidadesMap[habilidadCodigo].resultados.push(resultado);
      });
      
      // Tomar las primeras 3 habilidades con m√°s datos
      const habilidadesOrdenadas = Object.values(habilidadesMap)
        .sort((a, b) => b.resultados.length - a.resultados.length)
        .slice(0, 3);
      
      if (habilidadesOrdenadas.length === 0) {
        container.innerHTML = '<p style="color: var(--gray-500); text-align: center; padding: 20px;">No hay habilidades registradas</p>';
        return;
      }
      
      // Generar HTML de tarjetas
      container.innerHTML = habilidadesOrdenadas.map((hab, idx) => {
        const promedio = hab.resultados.length > 0 
          ? hab.resultados.reduce((sum, r) => {
              const meta = r.juegos_ejercicios?.meta_objetivo || 1;
              return sum + Math.min((r.resultado_obtenido / meta) * 100, 100);
            }, 0) / hab.resultados.length
          : 0;
        
        const tendencia = calcularTendenciaHabilidad(hab.porCiclo);
        
        return `
          <div class="habilidad-card" id="habilidadCard${idx}">
            <div class="habilidad-header" onclick="toggleHabilidadChart(${idx})" aria-expanded="false" aria-controls="habilidadChart${idx}">
              <div class="habilidad-info">
                <div class="habilidad-icon">${hab.info.icono || 'üß†'}</div>
                <div>
                  <div class="habilidad-nombre">${hab.info.nombre || hab.codigo}</div>
                  <div class="habilidad-descripcion">${hab.info.descripcion_padres || hab.info.descripcion || 'Habilidad cognitiva'}</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 16px;">
                <div class="habilidad-resultado">
                  <div class="habilidad-porcentaje">${Math.round(promedio)}%</div>
                  <div class="habilidad-tendencia">${tendencia}</div>
                </div>
                <button class="habilidad-expand-btn" aria-label="Expandir gr√°fico">‚ñº</button>
              </div>
            </div>
            <div class="habilidad-chart-container" id="habilidadChartContainer${idx}">
              <div class="habilidad-chart-inner">
                <canvas id="habilidadChart${idx}" aria-label="Gr√°fico de progreso de ${hab.info.nombre || hab.codigo}" role="img"></canvas>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Almacenar datos para los gr√°ficos
      window.habilidadesData = habilidadesOrdenadas;
    }
    
    function calcularTendenciaHabilidad(porCiclo) {
      const ciclos = Object.keys(porCiclo).map(Number).sort((a, b) => a - b);
      if (ciclos.length < 2) return 'Sin tendencia';
      
      const ultimo = porCiclo[ciclos[ciclos.length - 1]];
      const penultimo = porCiclo[ciclos[ciclos.length - 2]];
      
      const promUltimo = ultimo.reduce((a, b) => a + b, 0) / ultimo.length;
      const promPenultimo = penultimo.reduce((a, b) => a + b, 0) / penultimo.length;
      
      const diff = promUltimo - promPenultimo;
      if (diff > 5) return '‚Üë Mejorando';
      if (diff < -5) return '‚Üì Bajando';
      return '‚Üí Estable';
    }
    
    window.toggleHabilidadChart = function(idx) {
      const card = document.getElementById(`habilidadCard${idx}`);
      const isExpanded = card.classList.contains('expanded');
      
      // Cerrar todas las dem√°s
      document.querySelectorAll('.habilidad-card').forEach(c => c.classList.remove('expanded'));
      
      if (!isExpanded) {
        card.classList.add('expanded');
        
        // Crear gr√°fico si no existe
        if (!chartInstances[`habilidad${idx}`] && window.habilidadesData) {
          const hab = window.habilidadesData[idx];
          if (hab) {
            setTimeout(() => crearGraficoHabilidad(idx, hab), 100);
          }
        }
      }
    };
    
    function crearGraficoHabilidad(idx, hab) {
      const canvas = document.getElementById(`habilidadChart${idx}`);
      if (!canvas || chartInstances[`habilidad${idx}`]) return;
      
      const ciclos = Object.keys(hab.porCiclo).map(Number).sort((a, b) => a - b);
      const labels = ciclos.map(c => `Ciclo ${c}`);
      const datos = ciclos.map(c => {
        const valores = hab.porCiclo[c];
        return valores.reduce((a, b) => a + b, 0) / valores.length;
      });
      
      chartInstances[`habilidad${idx}`] = new Chart(canvas, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: hab.info.nombre || hab.codigo,
            data: datos,
            borderColor: '#4f46e5',
            pointBorderColor: '#4f46e5',
            pointBackgroundColor: '#fff',
            borderWidth: 3,
            pointRadius: 6,
            pointBorderWidth: 3,
            fill: true,
            backgroundColor: 'rgba(79, 70, 229, 0.1)',
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.95)',
              titleColor: '#1f2937',
              bodyColor: '#4b5563',
              borderColor: '#e5e7eb',
              borderWidth: 1,
              callbacks: {
                label: (item) => `Rendimiento: ${Math.round(item.raw)}%`
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: '#6b7280', font: { size: 11 } }
            },
            y: {
              beginAtZero: true,
              max: 100,
              grid: { color: '#f3f4f6' },
              ticks: {
                color: '#6b7280',
                font: { size: 11 },
                callback: (val) => val + '%'
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
