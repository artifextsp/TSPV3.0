<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credenciales de Acceso - Thinking Skills Program v2</title>
    <style>
        @media print {
            @page {
                size: A4;
                margin: 1.5cm;
            }
            .no-print {
                display: none;
            }
            .page-break {
                page-break-after: always;
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .section {
            margin-bottom: 50px;
        }
        
        .section-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        thead {
            background: #667eea;
            color: white;
        }
        
        th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #5568d3;
            font-size: 16px;
        }
        
        td {
            padding: 12px 16px;
            border: 1px solid #ddd;
            font-size: 15px;
        }
        
        tbody tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        tbody tr:hover {
            background: #f0f0f0;
        }
        
        .credential {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #667eea;
            background: #f0f4ff;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .password {
            font-family: 'Courier New', monospace;
            color: #e74c3c;
            font-weight: bold;
        }
        
        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .info-box strong {
            color: #2980b9;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .summary-card .number {
            font-size: 36px;
            font-weight: bold;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            margin: 10px 5px;
            cursor: pointer;
            border: none;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5568d3;
        }
        
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Thinking Skills Program v2</h1>
            <p>Credenciales de Acceso - Primera Clase</p>
            <p style="font-size: 14px; margin-top: 10px;">Fecha: <span id="fecha"></span></p>
        </div>
        
        <div class="no-print" style="text-align: center; margin-bottom: 30px;">
            <button class="btn" onclick="window.print()">üñ®Ô∏è Imprimir / Guardar PDF</button>
            <button class="btn" onclick="cargarDatos()">üîÑ Actualizar Datos</button>
        </div>
        
        <div class="summary" id="resumen"></div>
        
        <div class="info-box">
            <strong>‚ö†Ô∏è IMPORTANTE:</strong> Todos los usuarios deber√°n cambiar su contrase√±a en el primer inicio de sesi√≥n por seguridad.
        </div>
        
        <div class="section page-break">
            <div class="section-title">üë®‚Äçüéì ESTUDIANTES - Credenciales de Acceso</div>
            <div class="table-container">
                <table id="tabla-estudiantes">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Nombre</th>
                            <th>Grado</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-estudiantes">
                        <tr>
                            <td colspan="3" style="text-align: center; padding: 20px;">
                                Cargando datos...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="section page-break">
            <div class="section-title">üë®‚Äçüë©‚Äçüëß ACUDIENTES - Credenciales de Acceso</div>
            <div class="table-container">
                <table id="tabla-acudientes">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Nombre Acudiente</th>
                            <th>Email</th>
                            <th>Estudiante Asociado</th>
                            <th>Nombre Estudiante</th>
                            <th>Grado</th>
                            <th>Contrase√±a Inicial</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-acudientes">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 20px;">
                                Cargando datos...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="footer">
            <p>Thinking Skills Program v2 - Sistema de Pr√°cticas</p>
            <p>Este documento contiene informaci√≥n confidencial. Mantener en lugar seguro.</p>
        </div>
    </div>
    
    <script type="module">
        import { CONFIG } from './config/supabase.config.js';
        
        // Establecer fecha actual
        document.getElementById('fecha').textContent = new Date().toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        async function cargarDatos() {
            try {
                // Cargar estudiantes
                await cargarEstudiantes();
                // Cargar acudientes
                await cargarAcudientes();
                // Cargar resumen
                await cargarResumen();
            } catch (error) {
                console.error('Error cargando datos:', error);
                alert('Error al cargar los datos. Verifica la consola para m√°s detalles.');
            }
        }
        
        async function cargarEstudiantes() {
            const tbody = document.getElementById('tbody-estudiantes');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Cargando...</td></tr>';
            
            try {
                // Solo campos necesarios: nombre, apellidos, grado, codigo_estudiante
                const fields = ['codigo_estudiante', 'nombre', 'apellidos', 'grado', 'activo'];
                const baseUrl = `${CONFIG.API_BASE}/${CONFIG.USERS_TABLE}`;
                
                // Buscar estudiantes: filtrar por codigo_estudiante que empiece con 'EST'
                const params = new URLSearchParams();
                params.append('codigo_estudiante', 'like.EST%');
                params.append('activo', 'eq.true');
                params.append('select', fields.join(','));
                params.append('order', 'codigo_estudiante');
                
                const queryUrl = `${baseUrl}?${params.toString()}`;
                
                console.log('Cargando estudiantes desde:', queryUrl);
                
                const response = await fetch(queryUrl, {
                    method: 'GET',
                    headers: CONFIG.HEADERS
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error respuesta:', response.status, errorText);
                    throw new Error(`Error ${response.status}: ${errorText.substring(0, 200)}`);
                }
                
                const estudiantes = await response.json();
                
                console.log('Estudiantes cargados:', estudiantes.length);
                
                if (estudiantes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No hay estudiantes registrados</td></tr>';
                    return;
                }
                
                // Generar username basado en codigo_estudiante (TSP001, TSP002, etc.)
                tbody.innerHTML = estudiantes.map((est, index) => {
                    // Generar username desde codigo_estudiante (EST0001 -> TSP001)
                    let username = 'N/A';
                    if (est.codigo_estudiante) {
                        const match = est.codigo_estudiante.match(/\d+/);
                        if (match) {
                            username = 'TSP' + match[0].padStart(3, '0');
                        } else {
                            username = 'TSP' + String(index + 1).padStart(3, '0');
                        }
                    } else {
                        username = 'TSP' + String(index + 1).padStart(3, '0');
                    }
                    
                    // Nombre completo
                    const nombreCompleto = `${est.nombre || ''} ${est.apellidos || ''}`.trim() || 'N/A';
                    
                    return `
                        <tr>
                            <td><span class="credential">${username}</span></td>
                            <td>${nombreCompleto}</td>
                            <td>${est.grado || 'N/A'}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error completo:', error);
                tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: red;">
                    Error: ${error.message}<br>
                    <small>Revisa la consola (F12) para m√°s detalles</small>
                </td></tr>`;
            }
        }
        
        async function cargarAcudientes() {
            const tbody = document.getElementById('tbody-acudientes');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Cargando...</td></tr>';
            
            try {
                // Cargar acudientes (incluyendo password_hash para mostrar contrase√±a inicial)
                const acudienteFields = ['id', 'username', 'nombre', 'apellidos', 'email', 'estudiante_id', 'activo', 'password_hash'];
                const queryUrl = `${CONFIG.API_BASE}/${CONFIG.ACUDIENTES_TABLE}?activo=eq.true&select=${acudienteFields.join(',')}&order=username`;
                
                const response = await fetch(queryUrl, {
                    method: 'GET',
                    headers: CONFIG.HEADERS
                });
                
                if (!response.ok) throw new Error('Error al cargar acudientes');
                
                const acudientes = await response.json();
                
                if (acudientes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No hay acudientes registrados</td></tr>';
                    return;
                }
                
                // Cargar informaci√≥n de estudiantes asociados
                const estudianteIds = [...new Set(acudientes.map(a => a.estudiante_id).filter(Boolean))];
                let estudiantesMap = {};
                
                // Cargar estudiantes en lotes peque√±os (Supabase tiene l√≠mites)
                const batchSize = 20;
                for (let i = 0; i < estudianteIds.length; i += batchSize) {
                    const batch = estudianteIds.slice(i, i + batchSize);
                    const estudianteFields = ['id', 'codigo_estudiante', 'nombre', 'apellidos', 'grado'];
                    
                    // Construir filtro OR para este lote
                    const orConditions = batch.map(id => `id.eq.${id}`).join(',');
                    const estudiantesResponse = await fetch(
                        `${CONFIG.API_BASE}/${CONFIG.USERS_TABLE}?select=${estudianteFields.join(',')}&or=(${orConditions})`,
                        { headers: CONFIG.HEADERS }
                    );
                    
                    if (estudiantesResponse.ok) {
                        const estudiantes = await estudiantesResponse.json();
                        estudiantes.forEach(est => {
                            estudiantesMap[est.id] = est;
                        });
                    }
                }
                
                tbody.innerHTML = acudientes.map(acu => {
                    const estudiante = estudiantesMap[acu.estudiante_id] || {};
                    // Determinar contrase√±a inicial basada en el hash
                    const passwordInicial = obtenerPassword(acu.password_hash);
                    return `
                        <tr>
                            <td><span class="credential">${acu.username || 'N/A'}</span></td>
                            <td>${(acu.nombre || '') + ' ' + (acu.apellidos || '')}</td>
                            <td>${acu.email || 'N/A'}</td>
                            <td><strong>${estudiante.codigo_estudiante || 'N/A'}</strong></td>
                            <td>${(estudiante.nombre || '') + ' ' + (estudiante.apellidos || '')}</td>
                            <td>${estudiante.grado || 'N/A'}</td>
                            <td><span class="password">${passwordInicial}</span></td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error detallado:', error);
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: red;">Error: ${error.message}</td></tr>`;
            }
        }
        
        async function cargarResumen() {
            try {
                // Contar estudiantes: buscar por codigo_estudiante que empiece con 'EST'
                const estudiantesParams = new URLSearchParams();
                estudiantesParams.append('codigo_estudiante', 'like.EST%');
                estudiantesParams.append('activo', 'eq.true');
                estudiantesParams.append('select', 'id');
                
                const estudiantesResponse = await fetch(
                    `${CONFIG.API_BASE}/${CONFIG.USERS_TABLE}?${estudiantesParams.toString()}`,
                    { headers: CONFIG.HEADERS }
                );
                
                if (!estudiantesResponse.ok) {
                    console.error('Error contando estudiantes:', estudiantesResponse.status);
                    document.getElementById('resumen').innerHTML = `
                        <div class="summary-card">
                            <h3>Total Estudiantes</h3>
                            <div class="number">Error</div>
                        </div>
                        <div class="summary-card">
                            <h3>Total Acudientes</h3>
                            <div class="number">-</div>
                        </div>
                    `;
                    return;
                }
                
                const estudiantes = await estudiantesResponse.json();
                const totalEstudiantes = estudiantes.length;
                
                // Contar acudientes
                const acudientesResponse = await fetch(
                    `${CONFIG.API_BASE}/${CONFIG.ACUDIENTES_TABLE}?activo=eq.true&select=id`,
                    { headers: CONFIG.HEADERS }
                );
                const acudientes = await acudientesResponse.json();
                const totalAcudientes = acudientes.length;
                
                document.getElementById('resumen').innerHTML = `
                    <div class="summary-card">
                        <h3>Total Estudiantes</h3>
                        <div class="number">${totalEstudiantes}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Acudientes</h3>
                        <div class="number">${totalAcudientes}</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error cargando resumen:', error);
            }
        }
        
        function obtenerPassword(passwordHash) {
            // Hash de "123456"
            if (passwordHash === '8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92') {
                return '123456';
            }
            // Hash de "temporal123"
            if (passwordHash === 'a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3') {
                return 'temporal123';
            }
            return 'Cambiar en primer login';
        }
        
        // Hacer funci√≥n global para el bot√≥n
        window.cargarDatos = cargarDatos;
        
        // Cargar datos al iniciar
        cargarDatos();
    </script>
</body>
</html>
